<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogo Ortofrutta — Allegro Fattore</title>
  <meta name="description" content="Catalogo prodotti ortofrutticoli con ordine veloce via WhatsApp o consegna.">
  <meta property="og:title" content="Catalogo Ortofrutta" />
  <meta property="og:description" content="Sfoglia, aggiungi al carrello e invia l'ordine." />
  <meta property="og:type" content="website" />
  <style>
    :root{
      --bg:#f7f7f7; --text:#111; --muted:#666; --brand:#0a7c4a; --brand-700:#08633b; --card:#fff; --border:#e5e5e5; --warn:#c2410c; --err:#b91c1c; --err-bg:#fee2e2;
    }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif; color:var(--text); background:var(--bg)}
    a{color:inherit}
    .container{max-width:1100px; margin:0 auto; padding:0 16px}
    header{position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border)}
    .h-wrap{display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{font-weight:700; letter-spacing:.2px}
    .tabs{display:flex; gap:8px}
    .tab{appearance:none; border:none; background:transparent; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .tab[aria-selected="true"], .btn{background:var(--brand); color:#fff}
    .btn{border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#ececec; color:#111}

    main{padding:16px 0}
    .toolbar{display:grid; grid-template-columns:1fr 180px 160px 120px; gap:8px; margin:8px 0 12px}
    .toolbar input[type="search"], .toolbar select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .toolbar label{display:flex; align-items:center; gap:8px; font-size:.92rem; color:var(--muted)}

    .error{display:none; margin:10px 0 16px; padding:12px; border:1px solid var(--err); background:var(--err-bg); color:var(--err); border-radius:12px}
    .error pre{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:.85rem; color:#7f1d1d; background:#fff; border:1px solid #fca5a5; padding:8px; border-radius:8px}

    .grid{display:grid; grid-template-columns:repeat( auto-fill, minmax(220px, 1fr) ); gap:12px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; flex-direction:column}
    .card img{width:100%; height:150px; object-fit:cover; border-radius:12px; background:#fafafa}
    .card h3{margin:8px 0 2px; font-size:1.02rem}
    .muted{color:var(--muted); font-size:.92rem}
    .badge{display:inline-block; font-size:.75rem; background:#e9f7ef; color:var(--brand-700); border:1px solid #cfeadf; padding:2px 8px; border-radius:999px}

    .units{margin-top:8px; display:grid; gap:6px}
    .unit-row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .qty{display:flex; align-items:center; gap:4px}
    .step{width:28px; height:28px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer}
    .step:active{transform:translateY(1px)}
    .qty input{width:48px; padding:6px; text-align:center; border:1px solid var(--border); border-radius:8px}

    .empty{padding:24px; text-align:center; color:var(--muted)}

    /* Carrello */
    .cart{display:none}
    .cart.show{display:block}
    .form{display:grid; gap:10px; grid-template-columns:1fr}
    .form .row{display:grid; gap:8px; grid-template-columns:1fr 1fr}
    .form input, .form textarea, .form select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .summary{margin-top:16px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
    .summary h4{margin:0 0 8px}
    .summary .line{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee}
    .summary .line:last-child{border-bottom:none}
    .danger{color:var(--warn)}

    footer{padding:36px 0; text-align:center; color:var(--muted)}

    @media (max-width: 820px){
      .toolbar{grid-template-columns:1fr; gap:10px}
      .form .row{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <div class="container h-wrap">
      <div class="brand">Allegro Fattore — Catalogo</div>
      <div style="display:flex; align-items:center; gap:10px">
        <button id="header-cart-btn" class="btn secondary" aria-label="Vai al carrello">
          Carrello <span id="cart-indicator" class="badge" aria-live="polite">0</span>
        </button>
      </div>
    </div>
    <div class="container" style="padding-bottom:10px">
      <div role="tablist" class="tabs">
        <button id="tab-catalogo" role="tab" class="tab" aria-selected="true">Catalogo</button>
        <button id="tab-carrello" role="tab" class="tab" aria-selected="false">Ordina</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- TOOLBAR -->
    <div id="toolbar" class="toolbar" aria-label="Filtri catalogo">
      <input id="search" type="search" placeholder="Cerca prodotti… (es. mela, insalata)" aria-label="Cerca" />
      <select id="category">
        <option value="">Tutte le categorie</option>
      </select>
      <label><input id="only-available" type="checkbox" /> Solo disponibili</label>
      <button id="btn-tests" class="btn secondary" title="Esegui test API">Test API</button>
    </div>

    <!-- ERROR BANNER -->
    <div id="net-error" class="error" role="alert">
      <strong>Errore di rete:</strong> impossibile contattare il server del catalogo.
      <div class="muted" style="margin-top:6px">
        Possibili cause:
        <ul>
          <li>Endpoint non raggiungibile o URL errato.</li>
          <li>Web App di Google pubblicata con restrizioni (non "Chiunque").</li>
          <li>Blocco CORS/redirect al login di Google o problemi di connettività.</li>
        </ul>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button id="retry" class="btn">Riprova</button>
        <details>
          <summary>Dettagli tecnici</summary>
          <pre id="err-details"></pre>
        </details>
      </div>
    </div>

    <!-- CATALOGO -->
    <section id="catalogo" aria-labelledby="tab-catalogo">
      <div id="products-grid" class="grid" aria-live="polite"></div>
      <div id="catalog-empty" class="empty" style="display:none">Nessun prodotto trovato.</div>
      <div id="infinite-sentinel" class="empty" aria-hidden="true">Carico altri prodotti…</div>
    </section>

    <!-- CARRELLO / ORDINE -->
    <section id="carrello" class="cart" aria-labelledby="tab-carrello">
      <div class="form" style="margin-top:6px">
        <div class="row">
          <input type="text" id="customer-name" placeholder="Nome e cognome" autocomplete="name" />
          <input type="tel" id="customer-phone" placeholder="Telefono (mobile)" inputmode="tel" autocomplete="tel" />
        </div>
        <div class="row">
          <select id="delivery-option">
            <option value="ritiro">Ritiro presso punto di ritiro</option>
            <option value="consegna">Consegna a domicilio</option>
          </select>
          <input type="text" id="delivery-address" placeholder="Indirizzo (se consegna)" autocomplete="street-address" />
        </div>
        <textarea id="order-notes" rows="3" placeholder="Note per l'ordine (opzionale)"></textarea>
      </div>

      <div class="summary" id="checkout">
        <h4>Riepilogo</h4>
        <div id="checkout-lines"></div>
        <div class="line" style="font-weight:700"><span>Totale</span><span id="checkout-total">€ 0,00</span></div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button id="btn-send-order" class="btn">Invia ordine</button>
          <button id="btn-whatsapp" class="btn secondary">Invia via WhatsApp</button>
          <button id="btn-clear" class="btn secondary danger" title="Svuota carrello">Svuota</button>
        </div>
        <div id="checkout-msg" class="muted" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <footer class="container">
    <small>© <span id="yy"></span> Allegro Fattore — Demo catalogo</small>
  </footer>

  <script>
  // ======= CONFIG =======
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxTrFAo__1fJ0A6u-QEeepqA5esgXFc0qaaA-xUboJrbuCYQ9Q05U-kXE6nzrYOVojPVQ/exec"; // ← tuo deploy
  const WHATSAPP_NUMBER = "393927063209"; // 39 + numero senza + o spazi

  const PAGE_SIZE = 20;
  const FETCH_TIMEOUT_MS = 12000; // timeout protettivo
  const fmtEUR = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' });

  // ======= STATE =======
  let page = 1; let done = false; let loading = false;
  let currentQuery = ''; let currentCategory = ''; let onlyAvailable = false;
  let cart = {}; // { productId: { productName, image, items: { [unit]: { price, qty } } } }

  // ======= DOM =======
  const d = document;
  const grid = d.getElementById('products-grid');
  const emptyEl = d.getElementById('catalog-empty');
  const errorBox = d.getElementById('net-error');
  const errDetails = d.getElementById('err-details');
  const retryBtn = d.getElementById('retry');
  const sentinel = d.getElementById('infinite-sentinel');
  const searchEl = d.getElementById('search');
  const catEl = d.getElementById('category');
  const availEl = d.getElementById('only-available');
  const testsBtn = d.getElementById('btn-tests');
  const cartBtn = d.getElementById('header-cart-btn');
  const tabCatalogo = d.getElementById('tab-catalogo');
  const tabCarrello = d.getElementById('tab-carrello');
  const sectionCatalogo = d.getElementById('catalogo');
  const sectionCarrello = d.getElementById('carrello');
  const cartInd = d.getElementById('cart-indicator');
  const linesEl = d.getElementById('checkout-lines');
  const totalEl = d.getElementById('checkout-total');
  const msgEl = d.getElementById('checkout-msg');
  const nameEl = d.getElementById('customer-name');
  const phoneEl = d.getElementById('customer-phone');
  const delivEl = d.getElementById('delivery-option');
  const addrEl = d.getElementById('delivery-address');
  const notesEl = d.getElementById('order-notes');
  const btnSend = d.getElementById('btn-send-order');
  const btnWA = d.getElementById('btn-whatsapp');
  const btnClear = d.getElementById('btn-clear');

  // ======= UTIL =======
  function asNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartIndicator(); renderCheckoutSummary(); }
  function loadCart(){ try{ cart = JSON.parse(localStorage.getItem('cart')||'{}')||{}; }catch{ cart = {}; } updateCartIndicator(); renderCheckoutSummary(); }
  function cartCount(){ let c=0; for(const pid in cart){ const it=cart[pid].items; for(const u in it){ c += asNum(it[u].qty)||0; } } return c; }
  function updateCartIndicator(){ cartInd.textContent = String(cartCount()); }
  function setQty(product, unit, nextQty, price){
    const pid = product.id;
    if(!cart[pid]) cart[pid] = { productName: product.name, image: product.image || '', items:{} };
    if(!cart[pid].items[unit]) cart[pid].items[unit] = { price: asNum(price), qty:0 };
    cart[pid].items[unit].qty = Math.max(0, asNum(nextQty));
    if(cart[pid].items[unit].qty === 0){ delete cart[pid].items[unit]; }
    if(Object.keys(cart[pid].items).length === 0){ delete cart[pid]; }
    saveCart();
  }
  function clearCart(){ cart = {}; saveCart(); }

  // ======= NETWORK HELPERS =======
  async function fetchJSON(url, options = {}, timeout = FETCH_TIMEOUT_MS){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeout);
    try{
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ct = res.headers.get('content-type') || '';
      if(!ct.includes('application/json')){
        const text = await res.text();
        throw new Error(`Risposta non JSON (content-type: ${ct}). Primi byte: ${text.slice(0,120)}`);
      }
      return await res.json();
    } finally { clearTimeout(t); }
  }
  function showError(err){
    errorBox.style.display = '';
    errDetails.textContent = `URL: ${APPS_SCRIPT_URL}\nOrigine pagina: ${location.origin || location.protocol}\nErrore: ${err?.message || err}`;
  }
  function hideError(){ errorBox.style.display = 'none'; errDetails.textContent = ''; }

  // ======= RENDER PRODOTTI =======
  function unitRow(product, unit){
    const row = d.createElement('div');
    row.className = 'unit-row';
    const current = cart[product.id]?.items?.[unit.type]?.qty || 0;
    row.innerHTML = `
      <div><strong>${unit.type}</strong> <span class="muted">(${fmtEUR.format(asNum(unit.price))})</span></div>
      <div class="qty">
        <button class="step" data-act="dec" aria-label="Diminuisci">−</button>
        <input type="number" min="0" step="1" inputmode="numeric" value="${current}">
        <button class="step" data-act="inc" aria-label="Aumenta">+</button>
      </div>`;
    const minus = row.querySelector('[data-act="dec"]');
    const plus = row.querySelector('[data-act="inc"]');
    const input = row.querySelector('input');
    const sync = () => setQty(product, unit.type, input.value, unit.price);
    minus.addEventListener('click', ()=>{ input.value = Math.max(0, asNum(input.value)-1); sync(); });
    plus.addEventListener('click', ()=>{ input.value = asNum(input.value)+1; sync(); });
    input.addEventListener('change', sync);
    return row;
  }

  function renderProductCard(product){
    const card = d.createElement('div');
    card.className = 'card';
    const offer = product.offer ? `<span class="badge">Offerta</span>` : '';
    const firstPrice = product.units && product.units[0] ? fmtEUR.format(asNum(product.units[0].price)) : '';
    card.innerHTML = `
      <img src="${product.image || ''}" alt="${product.name || 'Prodotto'}" loading="lazy" onerror="this.style.display='none'">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <h3>${product.name || ''}</h3>
        ${offer}
      </div>
      <div class="muted">${product.description || ''}</div>
      <div class="muted" style="margin-top:4px">${firstPrice}</div>
      <div class="units" id="unit-${product.id}"></div>`;
    grid.appendChild(card);
    const unitsWrap = card.querySelector('.units');
    (product.units||[]).forEach(u => unitsWrap.appendChild(unitRow(product, u)));
  }

  function showEmpty(state){ emptyEl.style.display = state ? '' : 'none'; }

  async function loadNextPage(){
    if(loading || done) return; loading = true; hideError();
    const qs = new URLSearchParams({ action:'getProducts', page:String(page), pageSize:String(PAGE_SIZE) });
    if(currentQuery) qs.set('q', currentQuery);
    if(currentCategory) qs.set('category', currentCategory);
    if(onlyAvailable) qs.set('available', 'true');
    try{
      const data = await fetchJSON(`${APPS_SCRIPT_URL}?${qs.toString()}`, { cache:'no-store' });
      const items = data.products || [];
      if(page === 1){ grid.innerHTML=''; showEmpty(items.length === 0); }
      if(items.length === 0){ done = true; io.unobserve(sentinel); sentinel.textContent = '— fine elenco —'; loading = false; return; }
      items.forEach(renderProductCard);
      page++; loading = false;
    } catch(err){
      showError(err);
      loading = false;
      // evita loop di retry automatici
      io.unobserve(sentinel);
      sentinel.textContent = 'Errore di rete';
    }
  }

  function reload(){ page = 1; done = false; loading = false; grid.innerHTML=''; sentinel.textContent = 'Carico altri prodotti…'; io.observe(sentinel); loadNextPage(); }

  // ======= CATEGORIE =======
  async function buildCategories(){
    try{
      const opts = new URLSearchParams({ action:'getProducts', page:'1', pageSize:'100', available:'true' });
      const set = new Set();
      let currentPage = 1; let total = 0; const pageSize = 100;
      while(true){
        opts.set('page', String(currentPage));
        const data = await fetchJSON(`${APPS_SCRIPT_URL}?${opts.toString()}`, { cache:'no-store' });
        const items = data.products || [];
        items.forEach(p => { if(p.category) set.add(String(p.category)); });
        total = data.total || items.length; if(items.length < pageSize || (currentPage*pageSize) >= total) break; currentPage++;
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
      catEl.innerHTML = '<option value="">Tutte le categorie</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    } catch(err){
      // Se fallisce, non bloccare l'app: la toolbar resta utilizzabile
      console.warn('buildCategories error', err);
    }
  }

  // ======= CHECKOUT =======
  function renderCheckoutSummary(){
    linesEl.innerHTML = '';
    let total = 0; const frag = d.createDocumentFragment();
    for(const pid in cart){
      const p = cart[pid];
      for(const unit in p.items){
        const it = p.items[unit];
        const lineTot = asNum(it.qty) * asNum(it.price);
        total += lineTot;
        const row = d.createElement('div'); row.className = 'line';
        row.innerHTML = `<span>${p.productName} — ${unit} × ${it.qty}</span><span>${fmtEUR.format(lineTot)}</span>`;
        frag.appendChild(row);
      }
    }
    if(total === 0){ linesEl.innerHTML = '<div class="muted">Il carrello è vuoto.</div>'; }
    else{ linesEl.appendChild(frag); }
    totalEl.textContent = fmtEUR.format(total);
  }

  function prepareOrderPayload(){
    const items = [];
    for(const pid in cart){
      const p = cart[pid];
      for(const unit in p.items){
        const it = p.items[unit];
        if(asNum(it.qty) > 0){ items.push({ productId: pid, productName: p.productName, unit, quantity: asNum(it.qty) }); }
      }
    }
    return {
      customerName: nameEl.value.trim(),
      customerPhone: phoneEl.value.trim(),
      deliveryOption: delivEl.value,
      deliveryAddress: addrEl.value.trim(),
      orderNotes: notesEl.value.trim(),
      items
    };
  }

  async function sendOrder(){
    const payload = prepareOrderPayload();
    if(!payload.customerName || !payload.customerPhone){ msgEl.textContent = 'Inserisci nome e telefono.'; return; }
    if(payload.items.length === 0){ msgEl.textContent = 'Il carrello è vuoto.'; return; }
    btnSend.disabled = true; msgEl.textContent = 'Invio in corso…'; hideError();
    try{
      const data = await fetchJSON(APPS_SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      if(data && data.status === 'success'){
        msgEl.textContent = 'Ordine registrato!';
        clearCart();
      } else {
        msgEl.textContent = 'Salvataggio non riuscito.';
      }
    }catch(err){ msgEl.textContent = 'Errore di rete. Riprova.'; showError(err); }
    finally{ btnSend.disabled = false; }
  }

  function sendWhatsApp(){
    const payload = prepareOrderPayload();
    if(payload.items.length === 0){ msgEl.textContent = 'Il carrello è vuoto.'; return; }
    const lines = payload.items.map(it => `${it.productName} x ${it.quantity} ${it.unit}`);
    const text = `Nuovo ordine:%0A`+
      `Cliente: ${encodeURIComponent(payload.customerName)}%0A`+
      `Telefono: ${encodeURIComponent(payload.customerPhone)}%0A`+
      `Consegna: ${encodeURIComponent(payload.deliveryOption)}%0A`+
      (payload.deliveryAddress?`Indirizzo: ${encodeURIComponent(payload.deliveryAddress)}%0A`:``)+
      (payload.orderNotes?`Note: ${encodeURIComponent(payload.orderNotes)}%0A`:``)+
      `%0AProdotti:%0A- ${encodeURIComponent(lines.join('%0A- '))}`;
    const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
    window.open(url, '_blank');
  }

  // ======= TABS =======
  function showTab(tab){
    const cat = tab === 'catalogo';
    tabCatalogo.setAttribute('aria-selected', cat ? 'true' : 'false');
    tabCarrello.setAttribute('aria-selected', cat ? 'false' : 'true');
    sectionCatalogo.style.display = cat ? '' : 'none';
    d.getElementById('toolbar').style.display = cat ? '' : 'none';
    sectionCarrello.classList.toggle('show', !cat);
  }

  // ======= OBSERVER =======
  const io = new IntersectionObserver((entries)=>{
    if(entries.some(e=>e.isIntersecting)) loadNextPage();
  }, { rootMargin:'400px' });

  // ======= TESTS =======
  async function runApiTests(){
    hideError();
    const logs = [];
    function ok(m){ logs.push('✅ ' + m); }
    function ko(m){ logs.push('❌ ' + m); }
    try{
      const data1 = await fetchJSON(`${APPS_SCRIPT_URL}?action=getProducts&page=1&pageSize=1`, { cache:'no-store' });
      if(Array.isArray(data1.products)) ok('products è un array'); else ko('products non è un array');
      if(typeof data1.page === 'number') ok('page è un numero'); else ko('page mancante');
      if(typeof data1.pageSize === 'number') ok('pageSize è un numero'); else ko('pageSize mancante');
    }catch(err){ ko('GET getProducts fallito: ' + err.message); showError(err); }
    errDetails.textContent = logs.join('\n');
    errorBox.style.display = '';
  }

  // ======= INIT =======
  (function init(){
    document.getElementById('yy').textContent = new Date().getFullYear();
    loadCart();
    buildCategories().catch(()=>{});
    io.observe(sentinel);
    loadNextPage();

    // Listeners
    searchEl.addEventListener('input', ()=>{ currentQuery = searchEl.value.trim(); reload(); });
    catEl.addEventListener('change', ()=>{ currentCategory = catEl.value; reload(); });
    availEl.addEventListener('change', ()=>{ onlyAvailable = availEl.checked; reload(); });

    cartBtn.addEventListener('click', ()=> showTab('carrello'));
    tabCatalogo.addEventListener('click', ()=> showTab('catalogo'));
    tabCarrello.addEventListener('click', ()=> showTab('carrello'));

    btnSend.addEventListener('click', sendOrder);
    btnWA.addEventListener('click', sendWhatsApp);
    btnClear.addEventListener('click', ()=>{ clearCart(); msgEl.textContent = 'Carrello svuotato.'; });

    retryBtn.addEventListener('click', ()=>{ hideError(); reload(); });
    testsBtn.addEventListener('click', runApiTests);
  })();
  </script>
</body>
</html>
