<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Catalogo online</title>
  <meta name="description" content="Catalogo prodotti ortofrutticoli — ordina via WhatsApp" />
  <link rel="icon" href="https://lh3.googleusercontent.com/d/1i1Wpysj5jjQtmZ_ggOGBzuvoC_sW06Wh" type="image/png" />
  <style>
    :root{ --brand:#0a7c4a; --brand-700:#08633b; --bg:#f6f7f8; --card:#fff; --muted:#667085; --border:#e5e7eb; --danger:#b91c1c; }
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,'Noto Sans',sans-serif;margin:0;background:var(--bg);color:#111}
    a{color:inherit;text-decoration:none}

    /* HEADER */
    header{position:sticky;top:0;background:var(--card);z-index:40;border-bottom:1px solid var(--border)}
    .h-wrap{display:flex;align-items:center;justify-content:space-between;max-width:1100px;margin:0 auto;padding:10px 14px;gap:10px}
    .brand{display:flex;align-items:center;gap:10px}
    .brand img{width:28px;height:28px;border-radius:6px;object-fit:cover}
    .brand h1{font-size:1rem;line-height:1.1;margin:0}
    .cart-btn{display:flex;align-items:center;gap:8px;background:#eaf6ef;border:1px solid #cfeadf;color:var(--brand-700);padding:8px 12px;border-radius:999px;cursor:pointer}
    .cart-count{background:var(--brand);color:#fff;border-radius:999px;padding:2px 8px;font-weight:700}

    /* STICKY FILTER BAR */
    .toolbar-wrap{position:sticky;top:54px;background:var(--card);z-index:35;border-bottom:1px solid var(--border)}
    .toolbar{max-width:1100px;margin:0 auto;padding:10px 14px;display:grid;grid-template-columns:1fr 180px auto auto;gap:8px;align-items:center}
    .toolbar input[type="search"], .toolbar select{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .toolbar label{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:.92rem}
    @media(max-width:900px){ .toolbar{grid-template-columns:1fr 1fr 1fr} }
    @media(max-width:640px){ .toolbar{grid-template-columns:1fr} }

    /* CATALOGO */
    .container{max-width:1100px;margin:0 auto;padding:12px 14px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
    .thumb{position:relative;aspect-ratio:4/3;background:#fafafa;overflow:hidden;cursor:pointer}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .tap-hint{position:absolute;inset:auto 8px 8px auto;background:rgba(0,0,0,.72);color:#fff;font-size:.78rem;padding:6px 10px;border-radius:999px}
    .qty-badge{position:absolute;top:8px;left:8px;background:var(--brand);color:#fff;padding:2px 8px;border-radius:999px;font-weight:700;display:none}
    .body{padding:10px 12px;display:grid;gap:6px}
    .title{display:flex;justify-content:space-between;gap:8px;align-items:center}
    .title h3{margin:0;font-size:1rem}
    .badge{font-size:.72rem;background:#e9f7ef;color:var(--brand-700);border:1px solid #cfeadf;border-radius:999px;padding:1px 8px;white-space:nowrap}
    .desc{color:var(--muted);font-size:.9rem;display:-webkit-box;-webkit-line-clamp:2;line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
    .price-line{display:flex;gap:8px;align-items:baseline;font-size:.95rem}
	.unit-tag{font-size:.9rem; color:var(--muted); margin-left:6px}
	.unit-list{font-size:.9rem; color:var(--muted)}
	.unit-list .sep{margin:0 6px}
    .old{color:var(--muted);text-decoration:line-through}
    .new{font-weight:700}
    .empty{padding:20px;text-align:center;color:var(--muted)}

    /* CART DRAWER */
    .cart{position:fixed;right:0;top:0;background:var(--card);width:min(92vw,360px);height:100%;border-left:1px solid var(--border);overflow:auto;padding:14px;z-index:45;transform:translateX(100%);transition:transform .25s ease}
    .cart.open{transform:translateX(0)}
    .cart h2{margin:4px 0 8px}
    .cart .close{position:sticky;top:0;background:#f3f4f6;border:1px solid var(--border);border-radius:10px;padding:8px 10px;cursor:pointer;margin-bottom:8px}
    .cart ul{padding-left:18px}
    .row{display:grid;gap:8px;margin:8px 0}
    .row input, .row textarea{width:100%;padding:12px;border:1px solid var(--border);border-radius:10px;background:#fff}
    .btn{appearance:none;border:none;background:var(--brand);color:#fff;padding:12px 14px;border-radius:12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#e9ecef;color:#111}
    .btn.danger{background:#fee2e2;color:#991b1b}
    .loading{color:#c27803;font-size:.9rem}

    /* MODAL */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:flex-end;justify-content:center;z-index:50}
    .modal{background:var(--card);width:100%;max-width:560px;max-height:90vh;border-top-left-radius:16px;border-top-right-radius:16px;overflow:auto}
    @media(min-width:700px){ .modal{border-radius:16px;margin:40px} .modal-backdrop{align-items:center} }
    .modal .m-head{position:relative}
    .modal .m-head img{width:100%;height:240px;object-fit:cover;display:block;background:#fafafa}
    .modal .close{position:absolute;top:8px;right:8px;background:rgba(0,0,0,.55);color:#fff;border:none;border-radius:10px;padding:8px 10px;cursor:pointer}
    .modal .m-body{padding:14px;display:grid;gap:10px}
    .unit-select, .qty-controls{display:flex;gap:10px;align-items:center}
    .unit-select select{flex:1;padding:12px;border:1px solid var(--border);border-radius:10px}
    .qty-controls button{width:48px;height:48px;border-radius:12px;border:1px solid var(--border);background:#fff;font-size:1.4rem}
    .qty-controls input{width:84px;text-align:center;font-size:1.2rem;padding:10px;border:1px solid var(--border);border-radius:10px}
    .m-note{width:100%;min-height:84px;padding:10px;border:1px solid var(--border);border-radius:10px}
    .m-actions{display:flex;gap:10px;flex-wrap:wrap}
    .hint{font-size:.85rem;color:var(--muted)}

    /* Spinner + toast */
    #sentinel{height:48px}
    /* Spinner con logo */
.spinner{
  display:none;         /* mostrato via JS */
  place-items:center;
  padding:24px;
  text-align:center;
  gap:10px;
}

.spinner-logo{
  width:110px; height:auto;
  border-radius:16px;
  animation: pulse 1.2s ease-in-out infinite;
  filter: drop-shadow(0 4px 12px rgba(0,0,0,.10));
}

.spinner-text{
  font-size:.95rem;
  color: var(--muted);
}

/* Effetto “respiro” */
@keyframes pulse{
  0%   { transform: scale(.96); opacity:.85; }
  50%  { transform: scale(1);   opacity:1;   }
  100% { transform: scale(.96); opacity:.85; }
}

/* (Opzionale) versione overlay a pieno schermo per il primo caricamento
.spinner.overlay{
  position:fixed; inset:0; z-index:55;
  background:linear-gradient(180deg,#ffffff 0%, #fafafa 100%);
}
*/

	
	.old-price {
		text-decoration: line-through;
		color: #888;
		margin-right: 4px;
}
	.new-price {
		color: #111111;
		font-weight: bold;
}
/* Toggle accessibile per Ritiro/Consegna */
.switch{
  display:flex; align-items:center; gap:12px; cursor:pointer;
  user-select:none;
}
.switch input{
  position:absolute; opacity:0; width:0; height:0;
}
.switch .track{
  width:48px; height:28px; background:#e5e7eb; border:1px solid var(--border);
  border-radius:999px; position:relative; flex:none; transition:background .2s ease;
}
.switch .track::after{
  content:""; position:absolute; top:2px; left:2px;
  width:24px; height:24px; background:#fff; border-radius:999px;
  box-shadow:0 1px 2px rgba(0,0,0,.12); transition:transform .2s ease;
}
.switch input:checked + .track{
  background:var(--brand);
}
.switch input:checked + .track::after{
  transform: translateX(20px);
}
.switch .switch-label{
  display:flex; flex-direction:column; line-height:1.2;
}
.switch .switch-label .title{
  font-weight:600;
}
.switch .switch-label .hint{
  font-size:.85rem; color:var(--muted);
}
/* Header più solido e moderno */
header{
  position: sticky;
  top: 0;
  z-index: 10;
  background: #fff;
  border-bottom: 1px solid var(--border);
  box-shadow: 0 2px 10px rgba(0,0,0,.04);
}
.h-wrap{
  height: 100px;                  /* un filo più alto */
  padding-block: 8px;
}

/* Brand compatto */
.brand-logo{
  display: flex;
  align-items: center;
  gap: 12px;
}
.brand-img{
  height: 72px;         /* logo grande già su mobile */
  width: auto;
  border-radius: 12px;  /* leggermente più morbido */
  display: block;
}
@media (min-width: 768px){
  .brand-img{ height: 150px; }   /* ancora più grande su desktop */
}


/* Pill “Catalogo online” */
.brand-kicker{
  display: inline-block;
  font-size: 1rem;
  line-height: 1;
  padding: 8px 14px;
  border-radius: 999px;
  background: #eef6f0;           /* molto soft, coerente col brand */
  color: var(--brand-700);
  border: 1px solid #d7eadf;
  letter-spacing: .2px;
}

/* Utility (se non l’hai già) per elementi solo-visivi */
.sr-only{
  position:absolute !important;
  width:1px;height:1px;
  padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0;
}
/* Switch compatti dentro la toolbar */
.toolbar .switch {
  flex-direction: row;
  gap: 6px;
  font-size: .85rem;
}

.toolbar .switch-label {
  flex: 1;
  line-height: 1.1;
}

.toolbar .switch-label .hint {
  display: none; /* nasconde il sottotesto per risparmiare spazio */
}
/* Stato di invio per il bottone */
.btn {
  position: relative;
}
.btn.loading {
  pointer-events: none;
  opacity: .85;
}
/* Spinner inline nel bottone */
.btn {
  position: relative;
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.btn .btn-spinner {
  display: none;
  width: 18px; height: 18px;
  border: 2px solid rgba(255,255,255,.9);
  border-right-color: transparent;
  border-radius: 50%;
  animation: btnspin2 .8s linear infinite;
}

.btn.loading .btn-spinner { display: inline-block; }
.btn.loading {
  pointer-events: none;   /* niente click */
  opacity: .85;
}

@keyframes btnspin2 { to { transform: rotate(360deg); } }


  </style>
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="h-wrap">
      <div class="brand-logo">
  <img
    src="https://lh3.googleusercontent.com/d/1i1Wpysj5jjQtmZ_ggOGBzuvoC_sW06Wh"
    alt="Allegro Fattore"
    class="brand-img"
    loading="eager"
    decoding="async"
  />
  <span class="brand-kicker" aria-label="Sezione">Catalogo online</span>
</div>

      <button class="cart-btn" id="openCart" aria-label="Apri carrello">
        Carrello <span class="cart-count" id="cartCount">0</span>
      </button>
    </div>
  </header>

  <!-- STICKY FILTER BAR -->
 <div class="toolbar">
  <input id="search" type="search" placeholder="Cerca prodotti…" />
  <select id="category"></select>

  <label class="switch">
    <input id="unavailableOnly" type="checkbox">
    <span class="track" aria-hidden="true"></span>
    <span class="switch-label">
      <span class="title">Mostra non disponibili</span>
    </span>
  </label>

  <label class="switch">
    <input id="onlyOffers" type="checkbox">
    <span class="track" aria-hidden="true"></span>
    <span class="switch-label">
      <span class="title">Solo offerte</span>
    </span>
  </label>
</div>



  <!-- CATALOGO -->
  <main class="container">
    <div id="products" class="grid" aria-live="polite"></div>
    <div id="empty" class="empty" style="display:none">Nessun prodotto trovato.</div>
    <div class="spinner" id="spinner" aria-live="polite" aria-busy="true">
  <img
    class="spinner-logo"
    src="https://lh3.googleusercontent.com/d/1i1Wpysj5jjQtmZ_ggOGBzuvoC_sW06Wh"
    alt="Caricamento catalogo…"
    width="120" height="120" />
  <div class="spinner-text">Carico il catalogo…</div>
</div>
    <div id="sentinel" aria-hidden="true"></div>
  </main>
  <!-- CART MODAL -->
<div id="cartBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="cartTitle" style="display:none">
  <div class="modal">
    <div class="m-head">
      <button class="close" id="cartClose" aria-label="Chiudi">✕</button>
    </div>
    <div class="m-body">
      <h2 id="cartTitle" style="margin:0">Riepilogo ordine</h2>

      <ul id="cartItems"></ul>

      <form id="orderForm">
        <div class="row">
          <input type="tel" id="customerPhone" placeholder="Numero di telefono (obbligatorio)" required>
          <span id="lookupMsg" class="loading" style="display:none">Ricerca dati cliente…</span>
        </div>

        <div class="row">
          <input type="text" id="customerName" placeholder="Nome">
        </div>

        <!-- ✅ Checkbox: Ritiro in azienda (di default è consegna se NON spuntato) -->
        <div class="row">
  <label class="switch" id="pickupSwitch" role="switch" aria-checked="false">
    <input type="checkbox" id="pickupToggle" />
    <span class="track" aria-hidden="true"></span>
    <span class="switch-label">
      <span class="title">Ritiro in azienda</span>
      <span class="hint">Se disattivo: consegna a domicilio (predefinito)</span>
    </span>
  </label>
</div>


        <!-- ✅ Indirizzo sempre visibile -->
        <div class="row" id="rowAddress">
          <input type="text" id="deliveryAddress" placeholder="Indirizzo">
        </div>

        <div class="row">
          <textarea id="orderNotes" placeholder="Note generali sull'ordine"></textarea>
        </div>

        <div class="row" style="display:flex; gap:8px">
          <button type="submit" class="btn" id="submitOrderBtn">
  <span class="btn-spinner" aria-hidden="true"></span>
  <span class="btn-label">Trasmetti Ordine</span>
</button>


          <button type="button" id="btnClear" class="btn danger">Svuota</button>
        </div>
      </form>
    </div>
  </div>
</div>


  <!-- MODAL PRODUCT -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <div class="modal">
      <div class="m-head">
        <img id="mImg" alt="">
        <button class="close" id="mClose" aria-label="Chiudi">✕</button>
      </div>
      <div class="m-body">
        <div class="title">
          <h3 id="modalTitle" style="margin:0"></h3>
          <span id="mBadge" class="badge" style="display:none">Offerta</span>
        </div>
        <div id="mDesc" class="mini-muted"></div>
        <div id="mPrice" class="price-line"></div>

        <div class="unit-select">
          <label for="mUnit" class="mini-muted">Unità</label>
          <select id="mUnit" aria-label="Seleziona unità"></select>
        </div>

        <div class="qty-controls" aria-label="Quantità">
          <button type="button" id="mMinus" aria-label="Diminuisci">−</button>
          <input type="number" id="mQty" min="0" step="1" inputmode="numeric" value="0">
          <button type="button" id="mPlus" aria-label="Aumenta">+</button>
        </div>

        <textarea id="mNote" class="m-note" placeholder="Note per questo prodotto (es. maturi, piccoli…)"></textarea>

        <div class="m-actions">
          <button type="button" id="mSave" class="btn">Aggiorna carrello</button>
          <button type="button" id="mClose2" class="btn secondary">Chiudi</button>
        </div>

        <!--<div class="hint">Suggerimento: tocca l’immagine di un prodotto per aprire questo pannello.</div>-->
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast" role="status" aria-live="polite"></div>

    <script>
  // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycbybSgsS0hwNJMDHg7THWrC8OkLkz62jKsSY3HCxBFOytdveBxvZocUc04Ogso2sW8A9aA/exec";
  const WHATSAPP_NUMBER = "393927063209";

  // === STATE ===
  let page = 1, loading = false, done = false;
  const PAGE_SIZE = 24;
  let currentQuery = "", currentCategory = "", unavailableOnly = false, onlyOffers = false;

  let cart = []; // {id, productName, unit, quantity, note}
  let modalProduct = null;
  let renderedIds = new Set();


  // === HELPERS ===
  const $ = (id) => document.getElementById(id);
  const spinner = $("spinner");
  const submitBtn = document.getElementById('submitOrderBtn');
let sending = false;

function setSubmitting(state){
  sending = !!state;
  if (!submitBtn) return;
  submitBtn.disabled = state;
  submitBtn.classList.toggle('loading', state);
  submitBtn.setAttribute('aria-busy', state ? 'true' : 'false');
  const label = submitBtn.querySelector('.btn-label');
  if (label) label.textContent = state ? 'Ordine in invio…' : 'Trasmetti Ordine';
}

    // --- Riferimenti carrello/modale + consegna/ritiro ---
const cartBackdrop = document.getElementById('cartBackdrop');
const cartClose    = document.getElementById('cartClose');
const rowAddr      = document.getElementById('rowAddress');
const pickup       = document.getElementById('pickupToggle'); // checkbox "Ritiro in azienda"

  function showSpinner(b){ spinner.style.display = b ? "grid" : "none"; }
  function normalizePhone(phone){ const d = String(phone||"").replace(/[^\d]/g,""); if(d.startsWith("39"))return d; if(d.length===10 && d.startsWith("3"))return "39"+d; return d; }
  function fmtEUR(n){ return new Intl.NumberFormat('it-IT',{style:'currency',currency:'EUR'}).format(Number(n||0)); }
  function findCartIndex(id, unit){ return cart.findIndex(x => x.id===id && x.unit===unit); }
  function sumQtyByProduct(id){ return cart.filter(x=>x.id===id).reduce((a,c)=>a+Number(c.quantity||0),0); }
  function updateCartCount(){ $("cartCount").textContent = String(cart.reduce((a,c)=>a+Number(c.quantity||0),0)); }
  function showEmpty(flag){ $("empty").style.display = flag ? "" : "none"; }
  function toast(msg){ const t=$("toast"); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1600); }
  function syncDeliveryUI(){
  // Consegna = checkbox NON spuntata; Ritiro = spuntata
  const isPickup = !!(pickup && pickup.checked);

  // Indirizzo: sempre visibile (richiesto solo in consegna)
  if (rowAddr) rowAddr.style.display = ''; // sempre mostrato

  const addr = document.getElementById('deliveryAddress');
  if (addr) addr.required = !isPickup; // required se consegna (checkbox non spuntata)
}


  // localStorage
  function saveCart(){ localStorage.setItem('af_cart', JSON.stringify(cart)); updateCartCount(); updateCardBadges(); renderCart(); }
  function loadCart(){ try{ cart = JSON.parse(localStorage.getItem('af_cart')||'[]')||[]; }catch{ cart=[]; } updateCartCount(); }

  // Prezzi
  function priceLineHTML(unit){
  const price = Number(unit?.price || 0);
  const np    = Number(unit?.newPrice || 0);
  const ut    = String(unit?.type || "").trim(); // es. Kg, Pz, Cassa…
  const unitHtml = ut ? `<span class="unit-tag">/ ${ut}</span>` : "";

  if (np > 0 && np < price) {
    return `<span class="old">${fmtEUR(price)}</span><span class="new">${fmtEUR(np)}</span>${unitHtml}`;
  }
  return `<span>${fmtEUR(price)}</span>${unitHtml}`;
}
function otherUnitsHTML(units){
  if(!Array.isArray(units) || units.length <= 1) return '';
  const rest = units.slice(1); // escludiamo la prima
  const maxShow = 3; // quante unità mostrare subito
  const shown = rest.slice(0, maxShow);
  const parts = shown.map(u => {
    const ut = String(u?.type || '').trim();
    const base = Number(u?.price || 0);
    const promo = Number(u?.newPrice || 0);

    let html = "";
    if(promo > 0 && promo < base){
      html = `<span class="old-price">${fmtEUR(base)}</span> <span class="new-price">${fmtEUR(promo)}</span>`;
    } else {
      html = `<span>${fmtEUR(base)}</span>`;
    }
    return `${ut}: ${html}`;
  });
  if(rest.length > maxShow){
    parts.push(`+ altre ${rest.length - maxShow}`);
  }
  return `<div class="unit-list">${parts.join('<span class="sep">•</span>')}</div>`;
}


  // === MODALE PRODOTTO ===
  const backdrop = $("modalBackdrop");
  const mImg = $("mImg"), mTitle = $("modalTitle"), mDesc = $("mDesc"), mPrice = $("mPrice"),
        mUnit = $("mUnit"), mQty = $("mQty"), mNote = $("mNote"), mBadge=$("mBadge");
  $("mClose").onclick = closeModal; $("mClose2").onclick = closeModal;

  function openProductModal(p){
    modalProduct=p;
    mImg.src=p.image||""; mImg.alt=p.name||"Prodotto";
    mTitle.textContent=p.name||""; mDesc.textContent=p.description||"";
    mUnit.innerHTML="";
    (p.units||[]).forEach(u=>{const o=document.createElement('option'); o.value=u.type; o.textContent=u.type; mUnit.appendChild(o);});
    const hasOffer=(p.units||[]).some(u=>Number(u.newPrice||0)>0 && Number(u.newPrice)<Number(u.price||0));
    mBadge.style.display=hasOffer? "": "none";
    const u0=(p.units&&p.units[0])?p.units[0].type:"";
    const ex=cart.find(x=>x.id===p.id && x.unit===u0) || cart.find(x=>x.id===p.id);
    mUnit.value = ex? ex.unit : u0;
    setModalPriceLine();
    mQty.value = ex? Number(ex.quantity||0) : 0;
    mNote.value = ex? (ex.note||"") : "";
    backdrop.style.display="flex";
  }
  function closeModal(){ backdrop.style.display="none"; modalProduct=null; }
  function setModalPriceLine(){
    const unit=(modalProduct?.units||[]).find(u=>u.type===mUnit.value) || (modalProduct?.units||[])[0] || {price:0};
    mPrice.innerHTML = priceLineHTML(unit);
  }
  mUnit.addEventListener('change', ()=>{
    setModalPriceLine();
    const ex = cart.find(x=>x.id===modalProduct.id && x.unit===mUnit.value);
    mQty.value = ex? Number(ex.quantity||0):0;
    mNote.value = ex? (ex.note||''):'';
  });
  $("mMinus").onclick = ()=>{ const n=Math.max(0, Number(mQty.value||0)-1); mQty.value=n; };
  $("mPlus").onclick  = ()=>{ const n=Number(mQty.value||0)+1; mQty.value=n; };
  $("mSave").onclick  = ()=>{
    if(!modalProduct) return;
    const unit=mUnit.value;
    const qty=Math.max(0, Number(mQty.value||0));
    const note=mNote.value.trim();
    const idx=findCartIndex(modalProduct.id, unit);
    if(qty===0){ if(idx>-1)cart.splice(idx,1); }
    else {
      const row={ id:modalProduct.id, productName:modalProduct.name, unit, quantity:qty, note };
      if(idx>-1) cart[idx]=row; else cart.push(row);
    }
    saveCart();
    toast('Carrello aggiornato');
    closeModal();
  };

  // === CARD CATALOGO ===
  function cardHTML(p){
    const hasOffer=(p.units||[]).some(u=>Number(u.newPrice||0)>0 && Number(u.newPrice)<Number(u.price||0));
    const firstPrice=p.units && p.units[0] ? priceLineHTML(p.units[0]) : '';
    return `
      <div class="thumb" role="button" tabindex="0" aria-label="Dettagli ${p.name}">
        <span class="qty-badge" data-qty-for="${p.id}">0</span>
        <img src="${p.image||''}" alt="${p.name||'Prodotto'}" onerror="this.style.opacity=0.1" />
        <div class="tap-hint">Dettagli</div>
      </div>
      <div class="body">
        <div class="title">
          <h3>${p.name||''}</h3>
          ${hasOffer?'<span class="badge">Offerta</span>':''}
        </div>
        <div class="desc">${p.description||''}</div>
        <div class="price-line">${firstPrice}</div>
		${otherUnitsHTML(p.units || [])}
      </div>`;
  }

  function renderProducts(list, append=false){
  const wrap = $("products");
  if(!append) wrap.innerHTML = "";

  const frag = document.createDocumentFragment();

  // --- de-dupe: filtra prodotti già renderizzati
  const toRender = list.filter(p => {
    const pid = String(p.id || "");
    if (!pid || renderedIds.has(pid)) return false;
    renderedIds.add(pid);
    return true;
  });

  toRender.forEach(p => {
  const card = document.createElement('article');
  card.className = 'card';
  card.dataset.pid = p.id;
  card.innerHTML = cardHTML(p);

  const imgBtn = card.querySelector('.thumb');
  imgBtn.addEventListener('click', () => openProductModal(p));

  frag.appendChild(card);
});


  wrap.appendChild(frag);
  updateCardBadges();
  showEmpty(!wrap.children.length);
}


  function updateCardBadges(){
    document.querySelectorAll('[data-qty-for]').forEach(el=>{
      const id=el.getAttribute('data-qty-for');
      const tot=sumQtyByProduct(id);
      if(tot>0){ el.style.display='inline-block'; el.textContent=String(tot); }
      else { el.style.display='none'; }
    });
  }
  // === FILTRI / FETCH ===
  function buildQS(){
    const qs=new URLSearchParams({ action:'getProducts', page:String(page), pageSize:String(PAGE_SIZE) });
    if(currentQuery) qs.set('q', currentQuery);
    if(currentCategory) qs.set('category', currentCategory);
    if(onlyOffers) qs.set('offers','true');
    if(unavailableOnly) qs.set('unavailableOnly','true'); else qs.set('showUnavailable','false');
    return qs;
  }

  async function loadNextPage(){
  if (loading || done) return;
  loading = true;
  showSpinner(true);
  try{
    const qs = buildQS();
    const res = await fetch(`${API_URL}?${qs.toString()}`, { cache:'no-store' });
    const data = await res.json();
    const items = data.products || [];
    if (page === 1) renderProducts(items, false); else renderProducts(items, true);
    if (items.length < PAGE_SIZE) { 
      done = true; 
      observer.disconnect(); 
    }
    page++;
  } catch (err) {
    console.error('loadNextPage', err);
  } finally {
    loading = false;
    showSpinner(false);   // <-- nasconde sempre lo spinner
  }
}


  async function buildCategories(){
    try{
      const set=new Set(); let tmp=1; const ps=100;
      while(tmp<=3){
        const qs=new URLSearchParams({ action:'getProducts', page:String(tmp), pageSize:String(ps), showUnavailable:'false' });
        const res=await fetch(`${API_URL}?${qs.toString()}`);
        const data=await res.json();
        (data.products||[]).forEach(p=>{ if(p.category) set.add(String(p.category)); });
        if(!data.products || data.products.length<ps) break;
        tmp++;
      }
      const cats=Array.from(set).sort((a,b)=>a.localeCompare(b));
      $("category").innerHTML = '<option value="">Tutte le categorie</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    }catch(e){ console.warn('buildCategories', e); }
  }

  function reload(){
  page=1; done=false; loading=false;
  $("products").innerHTML="";
  renderedIds.clear();   // evita duplicati al nuovo caricamento
  observer.disconnect();                // <-- evita observer multipli
  observer.observe($("sentinel"));
  loadNextPage();
}

  // === CARRELLO ===
  $("openCart").onclick = () => { cartBackdrop.style.display = 'flex'; renderCart(); };
	cartClose.onclick     = () => { cartBackdrop.style.display = 'none'; };
  function renderCart(){
    const ul=$("cartItems");
    ul.innerHTML="";
    cart.forEach(c=>{
      const li=document.createElement('li');
      li.innerHTML = `${c.productName} × ${c.quantity} ${c.unit}` + (c.note? ` <span class="badge">Nota</span>` : '');
      ul.appendChild(li);
    });
  }
  $("btnClear").addEventListener('click', ()=>{ cart=[]; saveCart(); });

  // === LOOKUP CLIENTE ===
  $("customerPhone").addEventListener("blur", async (e)=>{
    const phone=normalizePhone(e.target.value.trim());
    if(!phone) return;
    $("lookupMsg").style.display='';
    try{
      const res=await fetch(`${API_URL}?action=getCustomerByPhone&phone=${encodeURIComponent(phone)}`);
      const data=await res.json();
      if(data.ok && data.customer){
        $("customerName").value = data.customer.name||"";
        $("deliveryAddress").value = data.customer.address||"";
        $("orderNotes").value = data.customer.notes||"";
      }
    }catch(err){ console.error('lookup', err); }
    $("lookupMsg").style.display='none';
  });

  // === INVIO ORDINE ===
  document.getElementById("orderForm").addEventListener("submit", async (e)=>{
  e.preventDefault();

  // 👉 evita doppi invii e mostra spinner sul bottone
  if (sending) return;
  setSubmitting(true);
  const label = submitBtn.querySelector('.btn-label');
	if (label) label.textContent = 'Ordine in invio…';

  if(!cart.length){ alert("Il carrello è vuoto."); setSubmitting(false); return; }

  const order={
    customerPhone: normalizePhone($("customerPhone").value.trim()),
    customerName: $("customerName").value.trim(),
    deliveryAddress: $("deliveryAddress").value.trim(),
    orderNotes: $("orderNotes").value.trim(),
    deliveryOption: (pickup && pickup.checked) ? 'ritiro' : 'consegna',
    items: cart.map(x=>({ productId:x.id, productName:x.productName, unit:x.unit, quantity:x.quantity, notes:x.note||'' }))
  };
  if(!order.customerPhone){ alert("Inserisci il numero di telefono."); setSubmitting(false); return; }
  if(!order.customerName){ alert("Inserisci il nome."); setSubmitting(false); return; }

  try{
    const res=await fetch(API_URL, { method:'POST', headers:{'Content-Type':'text/plain;charset=utf-8'}, body: JSON.stringify(order) });
    const data=await res.json();
    if(data.status==='success'){
      const lines = order.items.map(it => `${it.productName} x ${it.quantity} ${it.unit}${it.notes? ' (Nota: '+encodeURIComponent(it.notes)+')' : ''}`).join("%0A- ");
      const text =
        `Nuovo ordine:%0A` +
        `Cliente: ${encodeURIComponent(order.customerName)}%0A` +
        `Telefono: ${encodeURIComponent(order.customerPhone)}%0A` +
        `Modalità: ${encodeURIComponent(order.deliveryOption)}%0A` +
        (order.deliveryOption === 'consegna' && order.deliveryAddress ? `Indirizzo: ${encodeURIComponent(order.deliveryAddress)}%0A` : ``) +
        (order.orderNotes ? `Note: ${encodeURIComponent(order.orderNotes)}%0A` : ``) +
        `%0AProdotti:%0A- ${lines}`;

      window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, "_blank");
	  
	cart = [];            // svuota il carrello in memoria
	saveCart();           // persiste su localStorage e aggiorna badge + lista
	renderCart();         // (ridondante, ma ok se vuoi forzare il refresh)

// reset del form e stato di consegna/ritiro
document.getElementById('orderForm')?.reset();
if (pickup) {         // di default: consegna a domicilio
  pickup.checked = false;
  syncDeliveryUI();
}

// chiudi il carrello (opzionale, se preferisci tenerlo aperto rimuovi la riga)
cartBackdrop.style.display = 'none';

      toast('Ordine registrato');
      // (opzionale) lascia il bottone disabilitato finché l’utente non chiude il carrello
    } else {
      alert("Errore nel salvataggio dell'ordine.");
    }
  } catch(err){
    console.error('invio', err);
    alert('Errore di rete durante l\'invio dell\'ordine.');
  } finally {
    // 👉 riabilita il bottone e rimuove lo spinner
    setSubmitting(false);
  }
});
  // === EVENTI FILTRI ===
  let sTimer=null;
  $("search").addEventListener('input', ()=>{ clearTimeout(sTimer); sTimer=setTimeout(()=>{ currentQuery=$("search").value.trim(); reload(); }, 250); });
  $("category").addEventListener('change', ()=>{ currentCategory=$("category").value; reload(); });
  $("unavailableOnly").addEventListener('change', ()=>{ unavailableOnly=$("unavailableOnly").checked; reload(); });
  $("onlyOffers").addEventListener('change', ()=>{ onlyOffers=$("onlyOffers").checked; reload(); });

  // === INFINITE SCROLL ===
  const observer = new IntersectionObserver((entries)=>{ if(entries.some(e=>e.isIntersecting)) loadNextPage(); }, { rootMargin:'400px' });

  // === INIT ===
  (async function init(){
  loadCart();
  updateCartCount();
  //observer.observe($("sentinel"));
  await buildCategories();

  // --- aggancio evento e stato iniziale ---
  if (pickup) {
  const pickupSwitch = document.getElementById('pickupSwitch');
  const setAria = () => pickupSwitch?.setAttribute('aria-checked', pickup.checked ? 'true' : 'false');

  pickup.addEventListener('change', () => {
    syncDeliveryUI();
    setAria();
  });

  // Default: consegna a domicilio => checkbox NON spuntata
  pickup.checked = false;
  syncDeliveryUI();
  setAria();
}
  reload();
})();

  </script>
</body>
</html>
