<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Catalogo Ortofrutta — Allegro Fattore</title>
  <meta name="description" content="Catalogo prodotti ortofrutticoli con ordine veloce via WhatsApp o consegna.">
  <meta property="og:title" content="Catalogo Ortofrutta" />
  <meta property="og:description" content="Sfoglia, aggiungi al carrello e invia l'ordine." />
  <meta property="og:type" content="website" />
  <link rel="icon" href="https://lh3.googleusercontent.com/d/1i1Wpysj5jjQtmZ_ggOGBzuvoC_sW06Wh" type="image/png">
  <style>
    :root{ --bg:#f7f7f7; --text:#111; --muted:#666; --brand:#0a7c4a; --brand-700:#08633b; --card:#fff; --border:#e5e5e5; --warn:#c2410c; --err:#b91c1c; --err-bg:#fee2e2; }
    *{box-sizing:border-box}
    html,body{margin:0; padding:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans",sans-serif; color:var(--text); background:var(--bg)}
    a{color:inherit}
    .container{max-width:1100px; margin:0 auto; padding:0 16px}
    header{position:sticky; top:0; z-index:10; background:var(--card); border-bottom:1px solid var(--border)}
    .h-wrap{display:flex; align-items:center; justify-content:space-between; height:64px}
    .brand{font-weight:700; letter-spacing:.2px}
    .tabs{display:flex; gap:8px}
    .tab{appearance:none; border:none; background:transparent; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .tab[aria-selected="true"], .btn{background:var(--brand); color:#fff}
    .btn{border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .btn.secondary{background:#ececec; color:#111}

    main{padding:16px 0}
    .toolbar{display:grid; grid-template-columns:1fr 180px 180px 160px auto; gap:8px; margin:8px 0 12px}
    .toolbar input[type="search"], .toolbar select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .toolbar label{display:flex; align-items:center; gap:8px; font-size:.92rem; color:var(--muted)}

    .error{display:none; margin:10px 0 16px; padding:12px; border:1px solid var(--err); background:var(--err-bg); color:var(--err); border-radius:12px}
    .error pre{white-space:pre-wrap; font-family:ui-monospace, Menlo, Consolas, monospace; font-size:.85rem; color:#7f1d1d; background:#fff; border:1px solid #fca5a5; padding:8px; border-radius:8px}

    .grid{display:grid; grid-template-columns:repeat( auto-fill, minmax(240px, 1fr) ); gap:12px}
    .card{position:relative; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px; display:flex; flex-direction:column}
    .card img{width:100%; height:150px; object-fit:cover; border-radius:12px; background:#fafafa}
    .card h3{margin:8px 0 2px; font-size:1.02rem}
    .muted{color:var(--muted); font-size:.92rem}
    .badge{display:inline-block; font-size:.75rem; background:#e9f7ef; color:var(--brand-700); border:1px solid #cfeadf; padding:2px 8px; border-radius:999px}
    .badge.na{background:#f1f5f9; color:#334155; border-color:#e2e8f0}

    .units{margin-top:8px; display:grid; gap:8px}
    .unit-select{display:flex; align-items:center; gap:8px}
    .unit-select select{flex:1; padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .price-line{display:flex; align-items:baseline; gap:8px; margin-top:2px}
    .old-price{text-decoration:line-through; color:var(--muted)}
    .new-price{font-weight:700}

    .qty{display:flex; align-items:center; gap:4px}
    .step{width:28px; height:28px; border:1px solid var(--border); background:#fff; border-radius:8px; cursor:pointer}
    .step:active{transform:translateY(1px)}
    .qty input{width:48px; padding:6px; text-align:center; border:1px solid var(--border); border-radius:8px}

    .empty{padding:24px; text-align:center; color:var(--muted)}
    .soldout{position:absolute; inset:0; background:rgba(255,255,255,.7); border-radius:16px; display:flex; align-items:center; justify-content:center; font-weight:700; color:#7c2d12}

    .cart{display:none}
    .cart.show{display:block}
    .form{display:grid; gap:10px; grid-template-columns:1fr}
    .form .row{display:grid; gap:8px; grid-template-columns:1fr 1fr}
    .form input, .form textarea, .form select{width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:#fff}
    .summary{margin-top:16px; background:var(--card); border:1px solid var(--border); border-radius:16px; padding:12px}
    .summary h4{margin:0 0 8px}
    .summary .line{display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px dashed #eee}
    .summary .line:last-child{border-bottom:none}
    .danger{color:var(--warn)}
    footer{padding:36px 0; text-align:center; color:var(--muted)}

    @media (max-width: 880px){ .toolbar{grid-template-columns:1fr; gap:10px} .form .row{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <header>
    <div class="container h-wrap">
      <div class="brand">Allegro Fattore — Catalogo</div>
      <div style="display:flex; align-items:center; gap:10px">
        <button id="header-cart-btn" class="btn secondary" aria-label="Vai al carrello">
          Carrello <span id="cart-indicator" class="badge" aria-live="polite">0</span>
        </button>
      </div>
    </div>
    <div class="container" style="padding-bottom:10px">
      <div role="tablist" class="tabs">
        <button id="tab-catalogo" role="tab" class="tab" aria-selected="true">Catalogo</button>
        <button id="tab-carrello" role="tab" class="tab" aria-selected="false">Ordina</button>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- TOOLBAR -->
    <div id="toolbar" class="toolbar" aria-label="Filtri catalogo">
      <input id="search" type="search" placeholder="Cerca prodotti… (es. mela, insalata)" aria-label="Cerca" />
      <select id="category"><option value="">Tutte le categorie</option></select>
      <label><input id="show-unavailable" type="checkbox" /> Mostra non disponibili</label>
      <label><input id="only-offers" type="checkbox" /> Solo offerte</label>
      <div style="display:flex; gap:8px; justify-content:flex-end">
        <button id="btn-tests" class="btn secondary" title="Esegui test API" style="display:none">Test API</button>
      </div>
    </div>

    <!-- ERROR BANNER -->
    <div id="net-error" class="error" role="alert">
      <strong>Errore di rete:</strong> impossibile contattare il server del catalogo.
      <div class="muted" style="margin-top:6px">
        Possibili cause:
        <ul>
          <li>Endpoint non raggiungibile o URL errato.</li>
          <li>Web App di Google pubblicata con restrizioni (non "Chiunque").</li>
          <li>Blocco CORS / redirect al login o problemi di connettività.</li>
        </ul>
      </div>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap">
        <button id="retry" class="btn">Riprova</button>
        <details><summary>Dettagli tecnici</summary><pre id="err-details"></pre></details>
        <button id="use-demo" class="btn secondary" style="display:none">Usa dati demo</button>
      </div>
    </div>

    <!-- CATALOGO -->
    <section id="catalogo" aria-labelledby="tab-catalogo">
      <div id="products-grid" class="grid" aria-live="polite"></div>
      <div id="catalog-empty" class="empty" style="display:none">Nessun prodotto trovato.</div>
      <div id="infinite-sentinel" class="empty" aria-hidden="true">Carico altri prodotti…</div>
    </section>

    <!-- CARRELLO / ORDINE -->
    <section id="carrello" class="cart" aria-labelledby="tab-carrello">
      <div class="form" style="margin-top:6px">
        <div class="row">
          <!-- Telefono per primo -->
          <input type="tel" id="customer-phone" placeholder="Telefono (mobile)" inputmode="tel" autocomplete="tel" />
          <input type="text" id="customer-name" placeholder="Nome e cognome" autocomplete="name" />
        </div>
        <div id="lookup-status" class="muted" style="display:none; margin-top:-6px; margin-bottom:2px">Ricerca dati cliente…</div>

        <div class="row">
          <select id="delivery-option">
            <option value="ritiro">Ritiro presso punto di ritiro</option>
            <option value="consegna">Consegna a domicilio</option>
          </select>
          <input type="text" id="delivery-address" placeholder="Indirizzo (se consegna)" autocomplete="street-address" />
        </div>
        <textarea id="order-notes" rows="3" placeholder="Note per l'ordine (opzionale)"></textarea>
      </div>

      <div class="summary" id="checkout">
        <h4>Riepilogo</h4>
        <div id="checkout-lines"></div>
        <div class="muted" style="margin-top:8px">I prezzi finali verranno comunicati dopo pesatura.</div>
        <div style="display:flex; gap:10px; margin-top:12px; flex-wrap:wrap">
          <button id="btn-transmit" class="btn">Trasmetti ordine</button>
          <button id="btn-clear" class="btn secondary danger" title="Svuota carrello">Svuota</button>
        </div>
        <div id="checkout-msg" class="muted" style="margin-top:8px"></div>
      </div>
    </section>
  </main>

  <footer class="container"><small>© <span id="yy"></span> Allegro Fattore — Catalogo</small></footer>

  <script>
  // ======= CONFIG =======
  const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw79-SEwwYtcx6wUaN6NeY_J3pnPGJy2jHsDJi7xPEHJSuYqXGKMT2-bjSxeuFbc4Grng/exec";
  const WHATSAPP_NUMBER = "393927063209";

  const PAGE_SIZE = 20;
  const FETCH_TIMEOUT_MS = 12000;
  const fmtEUR = new Intl.NumberFormat('it-IT', { style:'currency', currency:'EUR' });
  const DEMO = location.hash.includes('demo');
  const SHOW_DEV = false;

  const DEMO_DATA = [
    { id:'APL-GALA-500', name:'Mela Gala', description:'Calibro 70/75', category:'Frutta', image:'', available:true,  units:[{type:'Kg', price:1.8, newPrice:1.5},{type:'Cassa', price:11.9}] },
    { id:'PER-WILLI-400', name:'Pera Williams', description:'Dolce e succosa', category:'Frutta', image:'', available:true,  units:[{type:'Kg', price:2.2}] },
    { id:'INS-GENT-300', name:'Insalata Gentile', description:'Freschissima',    category:'Verdura', image:'', available:true,  units:[{type:'Pz', price:1.2, newPrice:1.0}] },
    { id:'PAT-NOV-200',  name:'Patate Novelle', description:'Sacco 5kg',         category:'Verdura', image:'', available:false, units:[{type:'Kg', price:0.9},{type:'Sacco', price:4.0}] }
  ];
  let demoRows = [];

  let page = 1, done = false, loading = false;
  let currentQuery = '', currentCategory = '', showUnavailableOnly = false, onlyOffers = false;
  let cart = {};

  const d = document;
  const grid = d.getElementById('products-grid');
  const emptyEl = d.getElementById('catalog-empty');
  const errorBox = d.getElementById('net-error');
  const errDetails = d.getElementById('err-details');
  const retryBtn = d.getElementById('retry');
  const useDemoBtn = d.getElementById('use-demo');
  const sentinel = d.getElementById('infinite-sentinel');
  const searchEl = d.getElementById('search');
  const catEl = d.getElementById('category');
  const unavailEl = d.getElementById('show-unavailable');
  const offerEl = d.getElementById('only-offers');
  const testsBtn = d.getElementById('btn-tests');
  const cartBtn = d.getElementById('header-cart-btn');
  const tabCatalogo = d.getElementById('tab-catalogo');
  const tabCarrello = d.getElementById('tab-carrello');
  const sectionCatalogo = d.getElementById('catalogo');
  const sectionCarrello = d.getElementById('carrello');
  const cartInd = d.getElementById('cart-indicator');
  const linesEl = d.getElementById('checkout-lines');
  const msgEl = d.getElementById('checkout-msg');
  const nameEl = d.getElementById('customer-name');
  const phoneEl = d.getElementById('customer-phone');
  const delivEl = d.getElementById('delivery-option');
  const addrEl = d.getElementById('delivery-address');
  const notesEl = d.getElementById('order-notes');
  const lookupEl = d.getElementById('lookup-status');
  const btnTransmit = d.getElementById('btn-transmit');
  const btnClear = d.getElementById('btn-clear');

  // ======= UTIL =======
  function asNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
  function saveCart(){ localStorage.setItem('cart', JSON.stringify(cart)); updateCartIndicator(); renderCheckoutSummary(); }
  function loadCart(){ try{ cart = JSON.parse(localStorage.getItem('cart')||'{}')||{}; }catch{ cart = {}; } updateCartIndicator(); renderCheckoutSummary(); }
  function cartCount(){ let c=0; for(const pid in cart){ const it=cart[pid].items||{}; for(const u in it){ c += asNum(it[u].qty)||0; } } return c; }
  function updateCartIndicator(){ cartInd.textContent = String(cartCount()); }

  function setQtySelected(product, unit, nextQty, price, newPrice){
    const pid = product.id;
    if(!cart[pid]) cart[pid] = { productName: product.name, image: product.image || '', selectedUnit: unit, items:{} };
    cart[pid].selectedUnit = unit;
    cart[pid].items = { [unit]: { price: asNum(price), newPrice: asNum(newPrice)||0, qty: Math.max(0, asNum(nextQty)) } };
    if(cart[pid].items[unit].qty === 0){ delete cart[pid]; }
    saveCart();
  }
  function clearCart(){ cart = {}; saveCart(); }

  // ======= NETWORK HELPERS =======
  async function fetchJSON(url, options = {}, timeout = FETCH_TIMEOUT_MS){
    const ctrl = new AbortController();
    const t = setTimeout(() => ctrl.abort(), timeout);
    try{
      const res = await fetch(url, { ...options, signal: ctrl.signal });
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      const ct = res.headers.get('content-type') || '';
      if(!ct.includes('application/json')){
        const text = await res.text();
        throw new Error(`Risposta non JSON (content-type: ${ct}). Primi byte: ${text.slice(0,120)}`);
      }
      return await res.json();
    } finally { clearTimeout(t); }
  }
  function showError(err){ errorBox.style.display = ''; errDetails.textContent = `URL: ${APPS_SCRIPT_URL}\nOrigine pagina: ${location.origin || location.protocol}\nErrore: ${err?.message || err}`; }
  function hideError(){ errorBox.style.display = 'none'; errDetails.textContent = ''; }

  // ======= RENDER PRODOTTI =======
  function renderPriceLine(sel){
    const line = document.createElement('div'); line.className = 'price-line';
    const hasPromo = asNum(sel.newPrice) > 0 && asNum(sel.newPrice) < asNum(sel.price);
    if(hasPromo){ line.innerHTML = `<span class="old-price">${fmtEUR.format(asNum(sel.price))}</span><span class="new-price">${fmtEUR.format(asNum(sel.newPrice))}</span>`; }
    else { line.textContent = fmtEUR.format(asNum(sel.price)); }
    return line;
  }

  function renderProductCard(product){
    const card = d.createElement('div'); card.className = 'card';
    const hasOffer = (product.units||[]).some(u => asNum(u.newPrice) > 0 && asNum(u.newPrice) < asNum(u.price));
    const badges = [];
    if(hasOffer) badges.push('<span class="badge">Offerta</span>');
    if(product.available === false) badges.push('<span class="badge na">Non disponibile</span>');

    card.innerHTML = `
      <img src="${product.image || ''}" alt="${product.name || 'Prodotto'}" loading="lazy" onerror="this.style.display='none'">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:8px">
        <h3>${product.name || ''}</h3>
        <div style="display:flex; gap:6px">${badges.join('')}</div>
      </div>
      <div class="muted">${product.description || ''}</div>`;

    const wrap = document.createElement('div'); wrap.className = 'units';
    const unitRow = document.createElement('div'); unitRow.className = 'unit-select';
    const sel = document.createElement('select'); sel.ariaLabel = 'Unità di misura';
    (product.units||[]).forEach(u => { const o = document.createElement('option'); o.value = u.type; o.textContent = u.type; sel.appendChild(o); });
    unitRow.appendChild(sel);

    const qtyWrap = document.createElement('div'); qtyWrap.className = 'qty';
    const minus = document.createElement('button'); minus.className = 'step'; minus.textContent = '−'; minus.ariaLabel = 'Diminuisci';
    const input = document.createElement('input'); input.type = 'number'; input.min = '0'; input.step = '1'; input.inputMode = 'numeric'; input.value = '0';
    const plus = document.createElement('button'); plus.className = 'step'; plus.textContent = '+'; plus.ariaLabel = 'Aumenta';
    qtyWrap.append(minus, input, plus); unitRow.appendChild(qtyWrap);
    wrap.appendChild(unitRow);

    let currentUnit = (product.units||[])[0] || { price:0 };
    let priceLine = renderPriceLine(currentUnit);
    wrap.appendChild(priceLine);

    card.appendChild(wrap); grid.appendChild(card);

    function updatePriceLine(){
      const u = (product.units||[]).find(x => x.type === sel.value) || currentUnit;
      currentUnit = u; priceLine.remove(); priceLine = renderPriceLine(u); wrap.appendChild(priceLine);
      const inCart = cart[product.id]?.items?.[u.type]?.qty || 0; input.value = inCart;
    }
    sel.addEventListener('change', updatePriceLine);
    minus.addEventListener('click', ()=>{ input.value = Math.max(0, asNum(input.value)-1); setQtySelected(product, sel.value, input.value, currentUnit.price, currentUnit.newPrice); });
    plus.addEventListener('click', ()=>{ input.value = asNum(input.value)+1; setQtySelected(product, sel.value, input.value, currentUnit.price, currentUnit.newPrice); });
    input.addEventListener('change', ()=> setQtySelected(product, sel.value, input.value, currentUnit.price, currentUnit.newPrice));

    if(product.available === false){
      sel.disabled = true; minus.disabled = true; plus.disabled = true; input.disabled = true;
      const o = d.createElement('div'); o.className='soldout'; o.textContent='Al momento non disponibile'; card.appendChild(o);
    }
  }

  function showEmpty(state){ emptyEl.style.display = state ? '' : 'none'; }

  async function loadNextPage(){
    if (DEMO) return loadNextPageDemo();
    if(loading || done) return; loading = true; hideError();

    const qs = new URLSearchParams({ action:'getProducts', page:String(page), pageSize:String(PAGE_SIZE) });
    if(currentQuery) qs.set('q', currentQuery);
    if(currentCategory) qs.set('category', currentCategory);
    if(onlyOffers) qs.set('offers', 'true');
    // server: unavailableOnly=true => solo non disponibili; showUnavailable=false => solo disponibili (default)
    if (showUnavailableOnly) { qs.set('unavailableOnly','true'); } else { qs.set('showUnavailable','false'); }

    try{
      const data = await fetchJSON(`${APPS_SCRIPT_URL}?${qs.toString()}`, { cache:'no-store' });
      const items = data.products || [];
      if(page === 1){ grid.innerHTML=''; showEmpty(items.length === 0); }
      if(items.length === 0){ done = true; io.unobserve(sentinel); sentinel.textContent = '— fine elenco —'; loading = false; return; }
      items.forEach(renderProductCard);
      page++; loading = false;
    } catch(err){
      showError(err); loading = false; io.unobserve(sentinel); sentinel.textContent = 'Errore di rete';
    }
  }

  function filterSortDemo(){
    const q = (currentQuery||'').toLowerCase();
    demoRows = DEMO_DATA.filter(p => {
      const offer = (p.units||[]).some(u=> asNum(u.newPrice)>0 && asNum(u.newPrice) < asNum(u.price));
      const availCond = showUnavailableOnly ? (p.available === false) : (p.available === true);
      return (!q || (String(p.name||'').toLowerCase().includes(q) || String(p.description||'').toLowerCase().includes(q))) &&
             (!currentCategory || String(p.category||'').toLowerCase() === String(currentCategory).toLowerCase()) &&
             availCond && (!onlyOffers || offer);
    }).sort((a,b)=> {
      const ao = (a.units||[]).some(u=>asNum(u.newPrice)>0 && asNum(u.newPrice) < asNum(u.price));
      const bo = (b.units||[]).some(u => asNum(u.newPrice) > 0 && asNum(u.newPrice) < asNum(u.price));
      return (ao===bo) ? String(a.name||'').localeCompare(String(b.name||'')) : (ao?-1:1);
    });
  }

  function loadNextPageDemo(){
    if(loading || done) return; loading = true; hideError();
    if(page === 1){ filterSortDemo(); grid.innerHTML=''; showEmpty(demoRows.length === 0); }
    const start = (page-1)*PAGE_SIZE; const slice = demoRows.slice(start, start+PAGE_SIZE);
    if(slice.length === 0){ done = true; io.unobserve(sentinel); sentinel.textContent = '— fine elenco —'; loading = false; return; }
    slice.forEach(renderProductCard);
    page++; loading = false;
  }

  function reload(){ page = 1; done = false; loading = false; grid.innerHTML=''; sentinel.textContent = 'Carico altri prodotti…'; io.observe(sentinel); loadNextPage(); }

  // ======= CHECKOUT (solo elenco, senza prezzi/totali) =======
  function renderCheckoutSummary(){
    linesEl.innerHTML = '';
    const frag = d.createDocumentFragment();
    for(const pid in cart){
      const p = cart[pid]; if(!p || !p.items) continue;
      const u = p.selectedUnit || Object.keys(p.items)[0];
      const it = p.items[u]; if(!it || asNum(it.qty) <= 0) continue;
      const row = d.createElement('div'); row.className = 'line';
      row.innerHTML = `<span>${p.productName} — ${u} × ${it.qty}</span><span></span>`;
      frag.appendChild(row);
    }
    if(!frag.childNodes.length){ linesEl.innerHTML = '<div class="muted">Il carrello è vuoto.</div>'; }
    else { linesEl.appendChild(frag); }
  }

  function prepareOrderPayload(){
    const items = [];
    for(const pid in cart){
      const p = cart[pid]; if(!p || !p.items) continue;
      const u = p.selectedUnit || Object.keys(p.items)[0];
      const it = p.items[u]; if(!it || asNum(it.qty) <= 0) continue;
      items.push({ productId: pid, productName: p.productName, unit: u, quantity: asNum(it.qty) });
    }
    return {
      customerName: nameEl.value.trim(), customerPhone: phoneEl.value.trim(),
      deliveryOption: delivEl.value, deliveryAddress: addrEl.value.trim(),
      orderNotes: notesEl.value.trim(), items
    };
  }

  // ======= INVIO UNICO: POST + WhatsApp =======
  async function sendOrderAndWhatsApp(){
    const payload = prepareOrderPayload();
    if(!payload.customerPhone){ msgEl.textContent = 'Inserisci il telefono.'; return; }
    if(!payload.customerName){ msgEl.textContent = 'Inserisci il nome.'; return; }
    if(payload.items.length === 0){ msgEl.textContent = 'Il carrello è vuoto.'; return; }
    btnTransmit.disabled = true; msgEl.textContent = 'Trasmissione in corso…'; hideError();
    try{
      const data = await fetchJSON(APPS_SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'text/plain;charset=utf-8' }, body: JSON.stringify(payload) });
      if(data && data.status === 'success'){
        msgEl.textContent = 'Ordine registrato! Apro WhatsApp…';
        openWhatsAppFromPayload(payload);
        clearCart();
      } else {
        msgEl.textContent = 'Salvataggio non riuscito.';
      }
    }catch(err){ msgEl.textContent = 'Errore di rete. Riprova.'; showError(err); }
    finally{ btnTransmit.disabled = false; }
  }

  function openWhatsAppFromPayload(payload){
    const lines = payload.items.map(it => `${it.productName} x ${it.quantity} ${it.unit}`);
    const text = `Nuovo ordine:%0A`+
      `Cliente: ${encodeURIComponent(payload.customerName)}%0A`+
      `Telefono: ${encodeURIComponent(payload.customerPhone)}%0A`+
      `Consegna: ${encodeURIComponent(payload.deliveryOption)}%0A`+
      (payload.deliveryAddress?`Indirizzo: ${encodeURIComponent(payload.deliveryAddress)}%0A`:``)+
      (payload.orderNotes?`Note: ${encodeURIComponent(payload.orderNotes)}%0A`:``)+
      `%0AProdotti:%0A- ${encodeURIComponent(lines.join('%0A- '))}`;
    window.open(`https://wa.me/${WHATSAPP_NUMBER}?text=${text}`, '_blank');
  }

  // ======= LOOKUP CLIENTE =======
  async function lookupCustomerByPhone(){
    const raw = phoneEl.value.trim();
    if(!raw){ return; }
    // mostra avviso di ricerca e blocca i campi durante il fetch
    lookupEl.style.display = '';
    nameEl.disabled = true; addrEl.disabled = true;
    try{
      const qs = new URLSearchParams({ action:'getCustomerByPhone', phone: raw });
      const data = await fetchJSON(`${APPS_SCRIPT_URL}?${qs.toString()}`, { cache:'no-store' });
      if(data && data.ok && data.customer){
        if(!nameEl.value.trim()) nameEl.value = data.customer.name || '';
        if(!addrEl.value.trim()) addrEl.value = data.customer.address || '';
        if(!notesEl.value.trim() && data.customer.notes) notesEl.value = data.customer.notes;
        msgEl.textContent = 'Dati cliente caricati.';
      } else {
        msgEl.textContent = 'Nessun cliente trovato: compila i campi.';
      }
    } catch(err){
      console.warn('lookup error', err);
    } finally {
      lookupEl.style.display = 'none';
      nameEl.disabled = false; addrEl.disabled = false;
    }
  }

  // ======= TABS =======
  function showTab(tab){
    const cat = tab === 'catalogo';
    tabCatalogo.setAttribute('aria-selected', cat ? 'true' : 'false');
    tabCarrello.setAttribute('aria-selected', cat ? 'false' : 'true');
    sectionCatalogo.style.display = cat ? '' : 'none';
    d.getElementById('toolbar').style.display = cat ? '' : 'none';
    sectionCarrello.classList.toggle('show', !cat);
  }

  // ======= OBSERVER =======
  const io = new IntersectionObserver((entries)=>{ if(entries.some(e=>e.isIntersecting)) loadNextPage(); }, { rootMargin:'400px' });

  // ======= DEV =======
  function setDevUI(){ testsBtn.style.display = (SHOW_DEV || DEMO || location.hash.includes('dev')) ? '' : 'none'; useDemoBtn.style.display = (SHOW_DEV || DEMO || location.hash.includes('dev')) ? '' : 'none'; }
  async function runApiTests(){
    hideError(); const logs = []; const ok = m=>logs.push('✅ '+m); const ko = m=>logs.push('❌ '+m);
    try{
      const d1 = await fetchJSON(`${APPS_SCRIPT_URL}?action=getProducts&page=1&pageSize=3`, { cache:'no-store' });
      Array.isArray(d1.products) ? ok('products è un array') : ko('products non è un array');
      if(d1.products?.[0]){ ('units' in d1.products[0]) ? ok('units presente') : ko('units assente'); ('price' in (d1.products[0].units[0]||{})) ? ok('price presente') : ko('price assente'); ok('sample: '+JSON.stringify(d1.products[0].units[0])); }
    }catch(err){ ko('GET getProducts fallito: '+err.message); showError(err); }
    errDetails.textContent = logs.join('\n'); errorBox.style.display = '';
  }

  // ======= INIT =======
  (function init(){
    document.getElementById('yy').textContent = new Date().getFullYear();
    loadCart(); buildCategories().catch(()=>{});
    io.observe(sentinel); loadNextPage();

    // toolbar
    searchEl.addEventListener('input', ()=>{ currentQuery = searchEl.value.trim(); reload(); });
    catEl.addEventListener('change', ()=>{ currentCategory = catEl.value; reload(); });
    unavailEl.addEventListener('change', ()=>{ showUnavailableOnly = unavailEl.checked; reload(); });
    offerEl.addEventListener('change', ()=>{ onlyOffers = offerEl.checked; reload(); });

    // tab e carrello
    cartBtn.addEventListener('click', ()=> showTab('carrello'));
    tabCatalogo.addEventListener('click', ()=> showTab('catalogo'));
    tabCarrello.addEventListener('click', ()=> showTab('carrello'));

    // lookup su blur del telefono (se preferisci posso metterlo su input con debounce)
    phoneEl.addEventListener('blur', lookupCustomerByPhone);

    // invio e pulizia
    btnTransmit.addEventListener('click', sendOrderAndWhatsApp);
    btnClear.addEventListener('click', ()=>{ clearCart(); msgEl.textContent = 'Carrello svuotato.'; });

    // dev
    setDevUI();
    retryBtn.addEventListener('click', ()=>{ hideError(); reload(); });
    testsBtn.addEventListener('click', runApiTests);
    useDemoBtn.addEventListener('click', ()=>{ location.hash = '#demo'; location.reload(); });
  })();

  // ======= CATEGORIE =======
  async function buildCategories(){
    try{
      if (DEMO){
        const set = new Set(DEMO_DATA.map(p => p.category).filter(Boolean));
        const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
        catEl.innerHTML = '<option value="">Tutte le categorie</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
        return;
      }
      const opts = new URLSearchParams({ action:'getProducts', page:'1', pageSize:'100', showUnavailable:'false' });
      const set = new Set(); let currentPage = 1; const pageSize = 100;
      while(true){
        opts.set('page', String(currentPage));
        const data = await fetchJSON(`${APPS_SCRIPT_URL}?${opts.toString()}`, { cache:'no-store' });
        const items = data.products || []; items.forEach(p => { if(p.category) set.add(String(p.category)); });
        if(items.length < pageSize) break; currentPage++;
      }
      const cats = Array.from(set).sort((a,b)=>a.localeCompare(b));
      catEl.innerHTML = '<option value="">Tutte le categorie</option>' + cats.map(c=>`<option value="${c}">${c}</option>`).join('');
    } catch(err){ console.warn('buildCategories error', err); }
  }
  </script>
</body>
</html>
